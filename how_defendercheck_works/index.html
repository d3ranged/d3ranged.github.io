<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="d3ranged blog" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="d3ranged blog" /> <title> Как работает DefenderCheck - d3ranged blog </title> <link rel="alternate" href="http://localhost:4000/how_defendercheck_works/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/how_defendercheck_works/" /> <meta name="description" content="site description" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Как работает DefenderCheck | " /> <meta property="og:title" content="Как работает DefenderCheck | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/how_defendercheck_works/" /> <meta property="og:description" content="site description" /> <meta property="og:image" content="" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Как работает DefenderCheck | " /> <meta name="twitter:url" content="http://localhost:4000/how_defendercheck_works/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="" /> <meta name="twitter:image" content="" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="d3ranged blog" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"> <link rel="manifest" href="/assets/favicons/site.webmanifest"> <meta name="apple-mobile-web-app-title" content="d3ranged blog" /> <meta name="application-name" content="d3ranged blog" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <link rel="stylesheet" href="/assets/css/fontello.css" /> </head> <body data-theme="dark"> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/"><i class="icon-home"></i>home</a><a class="menu-link" href="/older/"><i class="icon-folder-open"></i>archive</a><a class="menu-link" href="/about/"><i class="icon-star"></i>about</a><a class="menu-link" href="/donate/"><i class="icon-dollar"></i></a></div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#signfinder">SIGNFINDER</a> </span> </div> <h1 class="header-title" itemprop="headline">Как работает DefenderCheck</h1> <div class="post-meta"> <span class="post-meta-item"> <!--<i class="icon-lock-open-alt"></i>--> <time datetime="2023-01-27T00:00:00+03:00" itemprop="datePublished"> Jan 27, 2023 </time> </span> <span class="post-meta-item" itemprop="author" itemscope itemtype="https://schema.org/Person"> <i class="icon-user-o"></i> <span itemprop="name">d3ranged</span> </span> <time hidden datetime="" itemprop="dateModified"> Jan 27, 2023 </time> <span hidden itemprop="publisher" itemtype="Person">d3ranged</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>Недавно в <a href="https://t.me/d3ranged_blog">чате</a> спросили: будет ли у <a href="https://github.com/d3ranged/sf2">SignFinder</a> поиск сигнатур как у <a href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a>?</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Недавно в <a href="https://t.me/d3ranged_blog">чате</a> спросили: будет ли у <a href="https://github.com/d3ranged/sf2">SignFinder</a> поиск сигнатур как у <a href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a>?</p> <p>Утверждается, что утилита показывает байты сигнатуры, узнавая их от антивируса. Кажется, кому-то удалось вскрыть формат базы и написать удобную оболочку, но это не так. Внутри простой, но любопытный, алгоритм.</p> <h2 id="модель-поиска-сигнатуры"> <a href="#модель-поиска-сигнатуры" class="anchor-head"></a> Модель поиска сигнатуры </h2> <p>Я переписал код, так чтобы с ним легко было играть, меняя расположение сигнатуры:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DefenderCheck</span><span class="p">:</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span>
		<span class="n">self</span><span class="p">.</span><span class="n">scan_count</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">self</span><span class="p">.</span><span class="n">last_good</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">self</span><span class="p">.</span><span class="n">show_size</span> <span class="o">=</span> <span class="mi">8</span>

	<span class="k">def</span> <span class="nf">IsDetected</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">part_data</span><span class="p">):</span>
		<span class="n">self</span><span class="p">.</span><span class="n">scan_count</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sign</span> <span class="ow">in</span> <span class="n">part_data</span>

	<span class="k">def</span> <span class="nf">DumpSign</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">show_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">file_data</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">DecreaseSize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>

		<span class="n">new_len</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">last_good</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">last_good</span><span class="p">)</span>

		<span class="nf">if </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span> <span class="o">==</span> <span class="n">new_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
			<span class="n">demo_part</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">DumpSign</span><span class="p">()</span>
			<span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"End of bad bytes at offset </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">{</span><span class="n">demo_part</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">new_len</span>

	<span class="k">def</span> <span class="nf">IncreaseSize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>

		<span class="n">new_len</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">new_len</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="s">"Exhausted the search. The binary looks good to go!"</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">new_len</span>

	<span class="k">def</span> <span class="nf">_Search</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
	
		<span class="n">self</span><span class="p">.</span><span class="n">file_data</span> <span class="o">=</span> <span class="n">file_data</span>

		<span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> 
		<span class="n">self</span><span class="p">.</span><span class="n">part_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		
		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

			<span class="n">part_data</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="p">]</span>

			<span class="n">is_detected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">IsDetected</span><span class="p">(</span><span class="n">part_data</span><span class="p">)</span>
			<span class="n">detect_str</span> <span class="o">=</span> <span class="s">'detect'</span> <span class="k">if</span> <span class="n">is_detected</span> <span class="k">else</span> <span class="s">'clean'</span>

			<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">scan_count</span><span class="si">}</span><span class="s">] File[0:</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">part_size</span><span class="si">}</span><span class="s">] -&gt; </span><span class="si">{</span><span class="n">detect_str</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">is_detected</span><span class="p">:</span>
				<span class="n">self</span><span class="p">.</span><span class="n">part_size</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">DecreaseSize</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">self</span><span class="p">.</span><span class="n">last_good</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">part_data</span><span class="p">)</span>
				<span class="n">self</span><span class="p">.</span><span class="n">part_size</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">IncreaseSize</span><span class="p">()</span>
	
	<span class="k">def</span> <span class="nf">Search</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>	

		<span class="k">try</span><span class="p">:</span>
			<span class="n">self</span><span class="p">.</span><span class="nf">_Search</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>		
		<span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
			<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">[!] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	
	<span class="n">defcheck</span> <span class="o">=</span> <span class="nc">DefenderCheck</span><span class="p">(</span><span class="s">'SIGN'</span><span class="p">)</span>

	<span class="n">defcheck</span><span class="p">.</span><span class="nc">Search</span><span class="p">(</span><span class="s">'___________SIGN_______'</span><span class="p">)</span>
</code></pre></div></div> <h2 id="особенности-алгоритма"> <a href="#особенности-алгоритма" class="anchor-head"></a> Особенности алгоритма </h2> <p>Логика проста, если файл детектируется, отрезаем от него конец, если детект остался - сигнатура находится до места отрыва. Мне кажется, метод был и раньше, конец отрезался через POSIX.truncate / WinApi.SetEndOfFile в других имплементациях той же мысли.</p> <p>Удивительно, но обрыв файла не смущает сканер, он честно ищет свои сигнатуры. Тестируем разные точки надреза, если при добавлении байта файл детектируется, а без него - нет, значит это конец сигнатуры.</p> <p>При положительном результате сканирования, берётся расстояние между текущим концом и максимальным размером чистого файла, и делится надвое.</p> <p>При отрицательном тесте, размер увеличивается. В комментариях к сказано, что в полтора раза, но в реальности, он прибавляет половину расстояния от надреза до конца файла.</p> <p>По всей видимости, это ошибка. В логах видно, что он делает лишние проверки: на [2] шаге становится известно, о детектировании начиная с 16 байта, но на [4] идёт проверка 17</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] File[0:11] -&gt; clean

[2] File[0:16] -&gt; detect

[3] File[0:13] -&gt; clean

[4] File[0:17] -&gt; detect

[5] File[0:15] -&gt; detect

[!] End of bad bytes at offset 15 -&gt; ____SIGN
</code></pre></div></div> <p>Тем не менее, сигнатура находится, хоть и не самым оптимальным способом. Точнее, не сигнатура, а ломающий её байт. Оригинальный софт выводит 256 байт слева от среза, выдавая их за найденную сигнатуру.</p> <p> <small class="post-add-comments"> <i class="icon-comment"></i> <a href="https://t.me/d3ranged_blog/13">Комментарии</a> </small> </p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/hi-to-all/" > <div class="nav-arrow">Previous</div> <span class="post-title">Добро пожаловать, снова</span> </a> <a class="post-nav-item post-nav-next" href="/blog_news_04_23/"> <div class="nav-arrow">Next</div> <span class="post-title">Новости блога</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="https://t.me/d3ranged_blog">telegram</a> <a class="footer_item" href="/feed.xml">rss</a> <a class="footer_item" href="https://github.com/d3ranged">github</a> <small class="footer_copyright"> все права нарушены </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
