<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="d3ranged blog" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="d3ranged blog" /> <title> Linux Host + Windows VM = Isolation - d3ranged blog </title> <link rel="alternate" href="http://localhost:4000/linux_vm_isolation/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/linux_vm_isolation/" /> <meta name="description" content="site description" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Linux Host + Windows VM = Isolation | " /> <meta property="og:title" content="Linux Host + Windows VM = Isolation | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/linux_vm_isolation/" /> <meta property="og:description" content="site description" /> <meta property="og:image" content="" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Linux Host + Windows VM = Isolation | " /> <meta name="twitter:url" content="http://localhost:4000/linux_vm_isolation/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="" /> <meta name="twitter:image" content="" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="d3ranged blog" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"> <link rel="manifest" href="/assets/favicons/site.webmanifest"> <meta name="apple-mobile-web-app-title" content="d3ranged blog" /> <meta name="application-name" content="d3ranged blog" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <link rel="stylesheet" href="/assets/css/fontello.css" /> </head> <body data-theme="dark"> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/"><i class="icon-home"></i>home</a><a class="menu-link" href="/older/"><i class="icon-folder-open"></i>archive</a><a class="menu-link" href="/about/"><i class="icon-star"></i>about</a><a class="menu-link" href="/donate/"><i class="icon-dollar"></i></a></div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Linux Host + Windows VM = Isolation</h1> <div class="post-meta"> <span class="post-meta-item"> <!--<i class="icon-lock-open-alt"></i>--> <time datetime="2021-06-05T00:00:00+03:00" itemprop="datePublished"> Jun 05, 2021 </time> </span> <span class="post-meta-item" itemprop="author" itemscope itemtype="https://schema.org/Person"> <i class="icon-user-o"></i> <span itemprop="name">d3ranged</span> </span> <time hidden datetime="" itemprop="dateModified"> Jun 05, 2021 </time> <span hidden itemprop="publisher" itemtype="Person">d3ranged</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>TL;DR: Linux, FDE, Whonix, Stream Isolation</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>TL;DR: Linux, FDE, Whonix, Stream Isolation</p> <h2 id="зачем-нам-linux"> <a href="#зачем-нам-linux" class="anchor-head"></a> Зачем нам Linux? </h2> <p>Большинство хакерских инструментов заточено под Windows, но сама система имеет критический недостаток.</p> <p>Телеметрия - это сбор и отправка данных о вашей машине. Они могут быть довольно чувствительными, вплоть до списка файлов и ввода с клавиатуры. Службу телеметрии можно отключить, но есть сомнения, что этого будет достаточно.</p> <p>Выходят новые обновления, которые могут содержать что угодно. Есть возможность отключить апдейты, но система продолжит “звонить” домой, это неотключаемая функция. При этом, нельзя запретить ей интернет фаерволлом, не сломав сеть всем остальным.</p> <p>Как оставить достоинства Windows, убрав его недостатки? Установить его на виртуальную машину под управлением Linux! Это позволит изолировать Windows, пустив её в сеть через виртуальный роутер, заодно спрятав выходной IP в Tor.</p> <p>Если вычислительные мощности вашей машины этого не позволяют, вместо виртуального роутера, можно использовать физический. Это выходит за рамки данной статьи, но вполне реально схожим образом настроить обычный роутер с OpenWrt или самодельный на Raspberry. Но, обо всём по порядку.</p> <h2 id="выбор-дистрибутива"> <a href="#выбор-дистрибутива" class="anchor-head"></a> Выбор дистрибутива </h2> <p>Дистры различаются окружением рабочего стола, пакетным менеджером и набором программ. Мне нравится Ubuntu и сделанные на её базе форки с другим окружением. Выбор сделан из-за наличия проприетарных драйверов и количества информации по настройке. Некоторые предпочитают Fedora. Но вы можете выбрать что-то своё, оценив live-cd на виртуальной машине.</p> <p>Драйвера могут стать головной болью, производители не торопятся поддерживать Linux, но в большинстве случаев устройства заработают. Если какая-то внешняя железка отказывается выполнять свои функции, достаточно узнать используемый в ней чип, открыв корпус или найдя нужную строку в документации. Обычно по ней находятся неплохие драйвера на гитхабе.</p> <h2 id="full-disk-encryption"> <a href="#full-disk-encryption" class="anchor-head"></a> Full Disk Encryption </h2> <p>Большинство дистров поддерживает шифрование диска из коробки. Для этого, при установке, необходимо выбрать расширенные опции разметки диска. Система называется <strong>LUKS</strong> и работает на базе AES-256.</p> <p><img src="ubuntu_luks.png" alt="luks" /></p> <p>При <a href="/password_1/">хорошем пароле</a>, перебор будет нерентабелен. Однако его реально украсть, подменив bootloader, установив аппаратный кейлогер или прочитав из оперативной памяти. Защиту от подобных вещей обсудим позже.</p> <h2 id="whonix"> <a href="#whonix" class="anchor-head"></a> Whonix </h2> <p>В качестве виртуального роутера используем <a href="https://www.whonix.org">Whonix</a>. Скачаем консольную версию, она требует меньше оперативной памяти. После импорта ova-файла, видим две новые виртуальные машины <strong>Whonix-Gateway-CLI</strong> и <strong>Whonix-Workstation-CLI</strong>. Они уже настроены, к первой подключено два сетевых адаптера: NAT и внутренняя сеть. Ведомые машины подключатся только к внутренней сети. Gateway выступает в качестве виртуального роутера, который заворачивает все подключения в Tor.</p> <blockquote> <p>Стандартные логин и пароль для Whonix - user:changeme</p> </blockquote> <p>Workstation несет программы, настроенные на работу через <a href="https://github.com/Whonix/uwt">uwtwrapper</a>: набор скриптов, вызывающих <a href="https://github.com/dgoulet/torsocks">torsocks</a> и <a href="https://github.com/wolfcw/libfaketime">timeprivacy</a> до основного приложения. Они перехватывают системные api в приложении, проксируя подключения через Tor и слегка меняя системное время.</p> <p>Зачем нужен torsocks, если все подключения на роутер идут через Tor? <a href="https://www.whonix.org/wiki/Stream_Isolation">Stream Isolation</a>. Представьте, что при старте ведомой машины, она обращается к ntp-серверу за актуальным временем, проверяет почту и обновляет браузер. Это может быть уникальной сигнатурой. Все три подключения идут через одну и ту же выходную ноду. Даже при смене маршрута внутри сети, характер трафика укажет на вас. По этой причине <a href="https://www.whonix.org/wiki/Tunnels/Introduction">не рекомендуется</a> использовать VPN за выходной нодой. Ваша анонимность падает до анонимности VPN-сервера.</p> <p>Проблема решается выбором отдельного <strong>SocksPort</strong> для каждого приложения. Tor позволяет открывать любое количество локальных сокс-портов, каждый из которых поведет трафик по новому маршруту. Полистаем их список (q для выхода):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>less /etc/torrc.d/65_gateway.conf 
</code></pre></div></div> <p>Некоторые имеют опции <strong>IsolateDestPort</strong> и <strong>IsolateDestAddr</strong>, принуждающие менять маршрут при смене IP или порта назначения.</p> <h2 id="настройка-virtualbox"> <a href="#настройка-virtualbox" class="anchor-head"></a> Настройка VirtualBox </h2> <p>Для ускорения гостевой машины, стоит включить поддержку виртуализации на уровне физического процессора: <strong>VT-X/AVD-V</strong>, но надо понимать, что исполнение инструкций на реальном железе открывает путь к атакам уровня <a href="https://en.wikipedia.org/wiki/Spectre_(security_vulnerability)">Spectre</a>.</p> <blockquote> <p>Если зажать shift при запуске виртуальной машины, VirtualBox не будет отображать её на экране, что довольно удобно после первичной настройки Gateway</p> </blockquote> <p>При общих тормозах, добавим логических ядер и оперативной памяти. При фризах графики, имеет смысл добавить видеопамяти и включить <strong>3d acceleration</strong>.</p> <h2 id="настройка-workstation---network"> <a href="#настройка-workstation---network" class="anchor-head"></a> Настройка Workstation - Network </h2> <p>Если мы захотим добавить свою виртуалку под Windows, необходимо правильно сконфигурировать сеть. В настройках виртуальной машины выбираем подключение только к Internal Network с тем же именем, которое назначено у второго адаптера Gateway, обычно это “Whonix”. В операционной системе ставим настройки подключения:</p> <ul> <li>IP: 10.152.152.50</li> <li>SUBNET: 255.255.192.0</li> <li>GATEWAY: 10.152.152.10</li> <li>DNS: 10.152.152.10</li> </ul> <p>Откуда взялись эти цифры? Выведем список адаптеров на Gateway:</p> <p><img src="whonix_gateway_ifconfig.png" alt="whonix_gateway_ifconfig" /></p> <p>Первый адаптер это NAT, подключенный к сети хоста, второй - внутренняя сеть, IP адрес Gateway забит в настройках Whonix и меняться не будет. Для каждой ведомой машины необходимо выбрать свой уникальный IP из той же подсети, как это сделано у родной Workstation:</p> <p><img src="whonix_workstation_ifconfig.png" alt="whonix_gateway_ifconfig" /></p> <p>Не спешите использовать машину, осталась пара деталей.</p> <h2 id="настройка-gateway---isolated-proxy"> <a href="#настройка-gateway---isolated-proxy" class="anchor-head"></a> Настройка Gateway - Isolated Proxy </h2> <p>По умолчанию, все пакеты отправленные на gateway переадресуются на <strong>TransPort</strong>. Это специальный порт для transparent proxy, заворачивающий все подключения в Tor, используя <a href="https://github.com/epidemics-scepticism/writing/blob/master/misconception.md">один маршрут</a> для всех приложений.</p> <p>Отключив прозрачное проксирование, получим ведомую систему, в которой интернет доступен только приложениям имеющим правильные настройки прокси.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /usr/local/etc/whonix_firewall.d/50_user.conf
</code></pre></div></div> <p>Дописываем пару строчек:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WORKSTATION_TRANSPARENT_TCP=0  
WORKSTATION_TRANSPARENT_DNS=0
</code></pre></div></div> <p>Нажимаем ctrl+o, ctrl+x для сохранения и выхода из редактора.</p> <h2 id="настройка-gateway---torrc"> <a href="#настройка-gateway---torrc" class="anchor-head"></a> Настройка Gateway - TorRC </h2> <p>Настроим Tor под себя, ограничив список <a href="https://manpages.debian.org/stretch/tor/torrc.5.en.html">выходных нод</a>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /usr/local/etc/torrc.d/50_user.conf
</code></pre></div></div> <p>Добавим следующий текст:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ExcludeExitNodes {ru},{??}  
GeoIPExcludeUnknown 1  
StrictNodes 1  
</code></pre></div></div> <p>Перезагружаем Gateway.</p> <h2 id="настройка-workstation---socks5"> <a href="#настройка-workstation---socks5" class="anchor-head"></a> Настройка Workstation - Socks5 </h2> <p>Под Linux достаточно воспользоваться услугами uwtwrapper, на Windows выставляем уникальные socks5 или http-proxy необходимым приложениям. Выбираем порт из вышеупомянутого <code class="language-plaintext highlighter-rouge">65_gateway.conf</code>. Для примера, поставим в качестве socks-proxy: <code class="language-plaintext highlighter-rouge">10.152.152.10:9101</code>.</p> <p>По умолчанию в torrc включены опции <strong>IsolateSOCKSAuth</strong> и <strong>IsolateClientAddr</strong>, таким образом можно назначать один и тот же порт разным приложениям, меняя данные авторизации. Так же, обращения к одному порту из под разных виртуальных машин (с разных локальных IP) приведет к изоляции их маршрутов.</p> <p>Если всё правильно, Windows должна показывать что интернет не подключен, а настроенные приложения будут работать через Tor.</p> <h2 id="тестируем"> <a href="#тестируем" class="anchor-head"></a> Тестируем </h2> <p>Установим <a href="https://curl.se">curl под Windows</a> или через пакетный менеджер на Linux. Воспользуемся тем фактом, что сервисы отображающие IP, при определённом User-Agent, отдают IP прямым текстом. При текущих настройках, напрямую DNS работать не будет, но socks5 позволяет делать DNS-запросы через себя:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -x socks5h://10.152.152.10:9101 ip.me  
curl -x socks5h://10.152.152.10:9102 ip.me  
curl -x socks5h://user:pass@10.152.152.10:9101 ip.me  
curl ip.me
</code></pre></div></div> <p>Последний запрос работать не должен, в остальных видим разные выходные адреса!</p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/password_2/" > <div class="nav-arrow">Previous</div> <span class="post-title">Эзотерическое кодирование</span> </a> <a class="post-nav-item post-nav-next" href="/hi-to-all/"> <div class="nav-arrow">Next</div> <span class="post-title">Добро пожаловать, снова</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="https://t.me/d3ranged_blog">telegram</a> <a class="footer_item" href="/feed.xml">rss</a> <a class="footer_item" href="https://github.com/d3ranged">github</a> <small class="footer_copyright"> все права нарушены </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
